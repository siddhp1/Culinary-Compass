{% extends "layout.html" %}
{% block content %}
<div class="text-center">
    <h1>Find Restaurants</h1>
    <h4>Here are some recommendations based on the restaurants you like.</h4>

    <!-- Map container -->
    <div id="map" style="height: 400px;"></div>

    <!-- Button to get coordinates -->
    <button id="getCoordinatesBtn" class="btn btn-primary">Get Coordinates</button>
<div>

<script>
// Initialize the map with a marker
function initMap() {
    // Try to get user's location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // User's location found
                var userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                initializeMap(userLocation);
            },
            function(error) {
                // User's location not found, set default location
                var defaultLocation = { lat: 43.6834, lng: -79.7660 }; // Brampton, Ontario, Canada
                initializeMap(defaultLocation);
            }
        );
    } else {
        // Geolocation not supported, set default location
        var defaultLocation = { lat: 43.6834, lng: -79.7660 }; // Brampton, Ontario, Canada
        initializeMap(defaultLocation);
    }
}

function initializeMap(initialPosition) {
    var map = new google.maps.Map(document.getElementById('map'), {
        center: initialPosition,
        zoom: 12
    });

    var marker = new google.maps.Marker({
        position: initialPosition,
        map: map,
        draggable: true
    });

    // Event listener to update marker position when it is dragged
    google.maps.event.addListener(marker, 'dragend', function(event) {
        updateCoordinates(event.latLng.lat(), event.latLng.lng());
    });
}

function updateCoordinates(lat, lng) {
    // Display coordinates in console
    console.log("Latitude: " + lat + ", Longitude: " + lng);

    // Send coordinates to the Flask route using AJAX
    var xhr = new XMLHttpRequest();
    var url = '/update_coordinates';  // Replace with your Flask route
    var params = 'lat=' + lat + '&lng=' + lng;
    xhr.open('POST', url, true);

    // Set content type header for POST request
    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

    // Send the request
    xhr.send(params);
}

// Load the Google Maps API
function loadMapScript() {
    var script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key={{ key }}&callback=initMap';
    script.defer = true;
    script.async = true;
    document.head.appendChild(script);
}

// Load the map script when the page is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    loadMapScript();
});
</script>

{% endblock content %}